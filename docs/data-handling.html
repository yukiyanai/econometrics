<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.542">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>KUT 計量経済学 - 4&nbsp; Rによるデータ操作</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./regression-estimation.html" rel="next">
<link href="./regression-intro.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./data-handling.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Rによるデータ操作</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">KUT 計量経済学</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/yukiyanai/metrics/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
</div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">はじめに</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./econometrics-prep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">実習の準備</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">回帰分析の基礎</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-handling.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Rによるデータ操作</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">回帰分析による統計的推定</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-test-inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">回帰分析による統計的検定と推論</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multiple-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">重回帰分析</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-misc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">回帰分析の応用</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-reports.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">分析結果の提示法</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interaction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">交差項の利用</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multiple-comparison.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">多重比較法</span></span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">このページの内容</h2>
   
  <ul>
<li><a href="#%E6%BA%96%E5%82%99" id="toc-準備" class="nav-link active" data-scroll-target="#%E6%BA%96%E5%82%99"><span class="header-section-number">4.1</span> 準備</a></li>
  <li>
<a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF" id="toc-データの読み込み" class="nav-link" data-scroll-target="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF"><span class="header-section-number">4.2</span> データの読み込み</a>
  <ul class="collapse">
<li><a href="#csv-%E5%BD%A2%E5%BC%8F%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E8%AA%AD%E3%82%80" id="toc-csv-形式のデータを読む" class="nav-link" data-scroll-target="#csv-%E5%BD%A2%E5%BC%8F%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E8%AA%AD%E3%82%80"><span class="header-section-number">4.2.1</span> CSV 形式のデータを読む</a></li>
  <li><a href="#excel-%E5%BD%A2%E5%BC%8F%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E8%AA%AD%E3%82%80" id="toc-excel-形式のデータを読む" class="nav-link" data-scroll-target="#excel-%E5%BD%A2%E5%BC%8F%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E8%AA%AD%E3%82%80"><span class="header-section-number">4.2.2</span> Excel 形式のデータを読む</a></li>
  <li><a href="#%E8%A4%87%E6%95%B0%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E6%89%B1%E3%81%84" id="toc-複数のデータセットの扱い" class="nav-link" data-scroll-target="#%E8%A4%87%E6%95%B0%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E6%89%B1%E3%81%84"><span class="header-section-number">4.2.3</span> 複数のデータセットの扱い</a></li>
  <li><a href="#%E4%BB%96%E3%81%AE%E7%B5%B1%E8%A8%88%E3%82%BD%E3%83%95%E3%83%88%E7%94%A8%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E8%AA%AD%E3%82%80" id="toc-他の統計ソフト用のデータを読む" class="nav-link" data-scroll-target="#%E4%BB%96%E3%81%AE%E7%B5%B1%E8%A8%88%E3%82%BD%E3%83%95%E3%83%88%E7%94%A8%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E8%AA%AD%E3%82%80"><span class="header-section-number">4.2.4</span> 他の統計ソフト用のデータを読む</a></li>
  </ul>
</li>
  <li>
<a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%89%8D%E5%87%A6%E7%90%86" id="toc-データの前処理" class="nav-link" data-scroll-target="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%89%8D%E5%87%A6%E7%90%86"><span class="header-section-number">4.3</span> データの前処理</a>
  <ul class="collapse">
<li><a href="#tidy-%E3%81%AA%E3%83%87%E3%83%BC%E3%82%BF" id="toc-tidy-なデータ" class="nav-link" data-scroll-target="#tidy-%E3%81%AA%E3%83%87%E3%83%BC%E3%82%BF"><span class="header-section-number">4.3.1</span> Tidy なデータ</a></li>
  <li><a href="#%E6%A7%98%E3%80%85%E3%81%AA%E5%89%8D%E5%87%A6%E7%90%86" id="toc-様々な前処理" class="nav-link" data-scroll-target="#%E6%A7%98%E3%80%85%E3%81%AA%E5%89%8D%E5%87%A6%E7%90%86"><span class="header-section-number">4.3.2</span> 様々な前処理</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Rによるデータ操作</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p><strong>今回の目標</strong></p>
<ul>
<li>様々な形式のデータをRに読み込ませる方法を身につける</li>
<li>データの整形方法を理解する</li>
</ul>
<section id="準備" class="level2" data-number="4.1"><h2 data-number="4.1" class="anchored" data-anchor-id="準備">
<span class="header-section-number">4.1</span> 準備</h2>
<p>準備として、必要なパッケージを読み込み、図の日本語が正しく表示されるようにする。</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">tidyverse</span>,</span>
<span>               <span class="va">haven</span>,</span>
<span>               <span class="va">readxl</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>（大学のPCで）<code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> がうまくいかない場合は、以下のようにパッケージを1つずつ読み込む（<strong>次回以降も同じようにする</strong>）。</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org">haven</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org">readxl</a></span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>次に、ggplot2のテーマとフォントの設定を行う。自分好みの設定がある場合は自由に変えてよい。Linuxには<a href="https://moji.or.jp/ipafont/">IPAexフォント</a> がインストールされていることを想定している（IPAex はインストールすれば maxOSやWindows でも使える）。</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="va">.Platform</span><span class="op">$</span><span class="va">OS.type</span> <span class="op">==</span> <span class="st">"windows"</span><span class="op">)</span> <span class="op">{</span> </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">fontregisterer</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">my_font</span> <span class="op">&lt;-</span> <span class="st">"Yu Gothic"</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">my_font</span> <span class="op">&lt;-</span> <span class="st">"Japan1"</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/capabilities.html">capabilities</a></span><span class="op">(</span><span class="st">"aqua"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">my_font</span> <span class="op">&lt;-</span> <span class="st">"HiraginoSans-W3"</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">my_font</span> <span class="op">&lt;-</span> <span class="st">"IPAexGothic"</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_gray</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">9</span>,</span>
<span>                     base_family <span class="op">=</span> <span class="va">my_font</span><span class="op">)</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="データの読み込み" class="level2" data-number="4.2"><h2 data-number="4.2" class="anchored" data-anchor-id="データの読み込み">
<span class="header-section-number">4.2</span> データの読み込み</h2>
<section id="csv-形式のデータを読む" class="level3" data-number="4.2.1"><h3 data-number="4.2.1" class="anchored" data-anchor-id="csv-形式のデータを読む">
<span class="header-section-number">4.2.1</span> CSV 形式のデータを読む</h3>
<p>データの形式として最もよく使われるものの1つが、CSV (comma separated values) という形式である。これはただのテキストファイルであり、値がカンマで区切られているだけである。</p>
<p>この形式のファイルの中身を理解するために、 <a href="https://yukiyanai.github.io/jp/classes/econometrics1/contents/data/fake_data_02.csv">fake_data_02.csv</a> を利用しよう。 まずは、上のダウンロードして、プロジェクト内の data ディレクトリ（フォルダ）にファイルを保存する。</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span></span>
<span>    url <span class="op">=</span> <span class="st">"https://yukiyanai.github.io/jp/classes/econometrics1/contents/data/fake_data_02.csv"</span>,</span>
<span>    destfile <span class="op">=</span> <span class="st">"data/fake_data_02.csv"</span></span>
<span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>ダウンロードがうまくできないとき（この後開いてみたら中身が壊れているとき）は、ブラウザ上でデータのリンクをクリック（あるいは右クリック; 副クリック）してファイルを保存し、プロジェクト内の data フォルダにダウンロードしたファイルをを移動しよう（以下で登場するファイルについても同様）</strong>。</p>
<p>ファイルがダウンロードできたら、そのファイルを開いてみよう。</p>
<p>まず、エクスプローラー（Macの場合はファインダ）でこのファイルを右クリック（副クリックまたは control を押しながらクリック）し、「プログラムから開く」を選び、LibreOffice Calc または Microsoft Excel で開いてみよう。見慣れた形式（スプレッドシート）でデータが見えるはずだ。確認できたらCalc/Excelを閉じよう。</p>
<p>次に、同じファイルを同様に「プログラムから開く」で<strong>Visual Studio Code</strong>（またはその他のテキストエディタ）で開いてみよう。ファイルの中身が見えるはずだ。CSV ファイルは、1行目は変数の名前、2行目以降は各行が1つの観測（このデータの場合は1人）、各行で異なる変数の間にカンマがある（そのため、カンマ区切りデータと呼ばれる）という特徴がある。</p>
<p>この形式のメリットとして、</p>
<ul>
<li>テキストファイルなのでファイルの中身が単純明快</li>
<li>容量が小さい</li>
<li>どんな統計ソフトでも読める</li>
<li>統計ソフトがなくてもメモ帳さえあれば編集可能</li>
</ul>
<p>などがあげられる（<strong>注意：このファイルを Word 等のワープロソフトで編集しないように。余分な内容が追加されてデータの中身が変わってしまう。</strong>）。</p>
<p>Excel 等に自分でデータを打ち込んで新しいデータセットを作るときは、できるだけこのCSV 形式を選んだ方がよい。</p>
<p>CSV形式のデータは、<code><a href="https://readr.tidyverse.org/reference/read_delim.html">readr::read_csv()</a></code> でRに読み込むことができる。</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mycsv1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">'data/fake_data_02.csv'</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 100 Columns: 6
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (1): sex
dbl (5): id, age, height, weight, income

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>プロジェクト内の data という名前のフォルダに入っていることを <code>data/</code> の部分で示し、そのフォルダ内の <code>fake_data_02.csv</code> を指定して開いている。 このとき、引用符を忘れないように注意する。引用符はシングル「’」でも、ダブル 「“」でもよい。</p>
<p>RStudio でデータを読み込むと、右下の <strong>Environment</strong>タブの<strong>Data</strong>のところに読み込んだデータセットが表示される。</p>
<p>念のために中身を少しだけ確認しておこう。</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">mycsv1</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100
Columns: 6
$ id     &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, …
$ sex    &lt;chr&gt; "male", "male", "male", "male", "male", "male", "male", "male",…
$ age    &lt;dbl&gt; 52, 33, 22, 33, 26, 37, 50, 30, 62, 51, 55, 36, 66, 42, 36, 47,…
$ height &lt;dbl&gt; 174.0, 175.3, 175.0, 170.1, 167.4, 159.3, 173.3, 162.5, 160.2, …
$ weight &lt;dbl&gt; 63.1, 70.2, 82.6, 81.8, 51.2, 57.8, 68.6, 47.2, 68.2, 59.4, 66.…
$ income &lt;dbl&gt; 3475810, 457018, 1627793, 6070642, 1083052, 2984929, 1481061, 1…</code></pre>
</div>
</div>
</section><section id="excel-形式のデータを読む" class="level3" data-number="4.2.2"><h3 data-number="4.2.2" class="anchored" data-anchor-id="excel-形式のデータを読む">
<span class="header-section-number">4.2.2</span> Excel 形式のデータを読む</h3>
<p>Excel のデータは、<strong>.xlsx</strong> または <strong>.xls</strong> というファイル名拡張子付きで保存されている。 このデータをRで読む方法もあるが、ここではExcel 形式のデータをCSV形式に変換し、それを上で説明した方法で読むことにする。</p>
<p>例として、<a href="https://yukiyanai.github.io/jp/classes/econometrics1/contents/data/fake_data_03.xlsx">fake_data_03.xlsx</a> を使う。まず、このデータをダウンロードし、Excel で開こう。</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span></span>
<span>    url <span class="op">=</span> <span class="st">"https://yukiyanai.github.io/jp/classes/econometrics1/contents/data/fake_data_03.xlsx"</span>,</span>
<span>    destfile <span class="op">=</span> <span class="st">"data/fake_data_03.xlsx"</span></span>
<span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>これを、CSV形式に変換し、プロジェクト内の data フォルダに保存する。そのために、以下を実行する。</p>
<ol type="1">
<li>Calc/Excel 左上の「ファイル」から「名前を付けて保存」を選ぶ</li>
<li>保存先として、プロジェクト（例：ドキュメント/econometrics）内の <strong>data</strong> フォルダを選ぶ</li>
<li>ポップアップで出てきたウィンドウの「ファイルの種類」で、<strong>CSV（カンマ区切り）(*.csv)</strong> を選び、保存する</li>
</ol>
<p>保存できたら、RStudioの右下の data フォルダをクリックし、<strong>fake_data_03.csv</strong> が保存されていることを確かめよう。</p>
<p>あとは先ほどと同様の方法でデータを読めばいいので、</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mycsv2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/fake_data_03.csv"</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 100 Columns: 6
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (1): sex
dbl (5): id, age, height, weight, income

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>と、する。RStudio の Environment タブで、データが読み込めたこと（<code>mycsv2</code>というデータが追加されたこと）を確認しよう。</p>
<p>念のために中身を少しだけ確認しておこう。</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">mycsv2</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100
Columns: 6
$ id     &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, …
$ sex    &lt;chr&gt; "male", "male", "male", "male", "male", "male", "male", "male",…
$ age    &lt;dbl&gt; 46, 22, 61, 48, 44, 23, 46, 60, 30, 25, 26, 22, 36, 65, 20, 58,…
$ height &lt;dbl&gt; 168.3, 177.1, 171.6, 170.2, 168.5, 160.7, 170.3, 163.7, 174.8, …
$ weight &lt;dbl&gt; 72.1, 85.4, 81.8, 65.2, 66.0, 50.8, 75.1, 67.1, 76.7, 63.7, 72.…
$ income &lt;dbl&gt; 2102061, 2729262, 1193016, 3014919, 3982087, 3702544, 7930623, …</code></pre>
</div>
</div>
<p>あるいは、<code><a href="https://readxl.tidyverse.org/reference/read_excel.html">readxl::read_excel()</a></code> でExcelファイルを読み込むこともできる。</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#pacman::p_load(readxl)</span></span>
<span><span class="va">myxl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span><span class="st">"data/fake_data_03.xlsx"</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>念のために中身を少しだけ確認しておこう。</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">myxl</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100
Columns: 6
$ id     &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, …
$ sex    &lt;chr&gt; "male", "male", "male", "male", "male", "male", "male", "male",…
$ age    &lt;dbl&gt; 46, 22, 61, 48, 44, 23, 46, 60, 30, 25, 26, 22, 36, 65, 20, 58,…
$ height &lt;dbl&gt; 168.3, 177.1, 171.6, 170.2, 168.5, 160.7, 170.3, 163.7, 174.8, …
$ weight &lt;dbl&gt; 72.1, 85.4, 81.8, 65.2, 66.0, 50.8, 75.1, 67.1, 76.7, 63.7, 72.…
$ income &lt;dbl&gt; 2102061, 2729262, 1193016, 3014919, 3982087, 3702544, 7930623, …</code></pre>
</div>
</div>
</section><section id="複数のデータセットの扱い" class="level3" data-number="4.2.3"><h3 data-number="4.2.3" class="anchored" data-anchor-id="複数のデータセットの扱い">
<span class="header-section-number">4.2.3</span> 複数のデータセットの扱い</h3>
<p>ここまでで3つのデータセットを読み込んだ（そのうち2つの内容は同じだが）ので、RStudioのEvironment タブには、3つのデータセット（データフレーム）、<code>mycsv1</code>, <code>mycsv2</code>, <code>myxl</code> が表示されているはずである。このように、Rには複数のデータを同時に利用できるというメリットがある。</p>
<p>このうち、csvファイルから読み込んだデータセットについて、データに含まれる変数を確認してみよう。</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">mycsv1</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "id"     "sex"    "age"    "height" "weight" "income"</code></pre>
</div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">mycsv2</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "id"     "sex"    "age"    "height" "weight" "income"</code></pre>
</div>
</div>
<p>2つのデータセットに含まれる変数名は同じようである。</p>
<p>では、2つのデータはまったく同じものだろうか。ためしに、それぞれのデータセット身長 (height) の平均値を求めてみよう。</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mycsv1</span><span class="op">$</span><span class="va">height</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 163.746</code></pre>
</div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mycsv2</span><span class="op">$</span><span class="va">height</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 162.907</code></pre>
</div>
</div>
<p>平均値が異なる。つまり、変数名は同じでも、データの中身は違うようだ。</p>
<p>このように、異なるデータセットが同じ名前の変数を含んでいることがあるので注意が必要だ。既に学習したとおり、Rでは <code>データセット名$変数名</code> とすることで、同じ名前の変数でも、異なるデータセットに属している場合にはそれらを区別して利用することができる。</p>
</section><section id="他の統計ソフト用のデータを読む" class="level3" data-number="4.2.4"><h3 data-number="4.2.4" class="anchored" data-anchor-id="他の統計ソフト用のデータを読む">
<span class="header-section-number">4.2.4</span> 他の統計ソフト用のデータを読む</h3>
<section id="stata" class="level4" data-number="4.2.4.1"><h4 data-number="4.2.4.1" class="anchored" data-anchor-id="stata">
<span class="header-section-number">4.2.4.1</span> <strong>Stata</strong>
</h4>
<p>R以外に計量経済学でよく利用される分析ソフトとして、Stataというものがある。Stata のデータセットには、<strong>.dta</strong> というファイル名拡張子が付いている。</p>
<p>StataのファイルをRで読みたいときは、<strong>haven</strong> というパッケージに含まれる <code><a href="https://haven.tidyverse.org/reference/read_dta.html">read_dta()</a></code>という関数を使う。</p>
<p>例として、<a href="https://yukiyanai.github.io/jp/classes/econometrics1/contents/data/fake_data_stata.dta">fake_data_stata.dta</a> をダウンロードし、<strong>data</strong> フォルダに保存しよう。</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span></span>
<span>    url <span class="op">=</span> <span class="st">"https://yukiyanai.github.io/jp/classes/econometrics1/contents/data/fake_data_stata.dta"</span>,</span>
<span>    destfile <span class="op">=</span> <span class="st">"data/fake_data_stata.dta"</span></span>
<span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>これを読むには、まず <strong>haven</strong> パッケージを読み込むことが必要である（インストールされていない場合はまずインストールする）。</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#pacman::p_load(haven)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>パッケージが読み込めたら、データを読む。</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mydta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://haven.tidyverse.org/reference/read_dta.html">read_dta</a></span><span class="op">(</span><span class="st">"data/fake_data_stata.dta"</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>RStudio の Environment タブで、データが読み込めたことを確認しよう。</p>
<p>念のために中身も少しだけ確認しておこう。</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">mydta</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100
Columns: 6
$ id     &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, …
$ sex    &lt;chr&gt; "male", "male", "male", "male", "male", "male", "male", "male",…
$ age    &lt;dbl&gt; 31, 57, 52, 46, 58, 49, 52, 34, 57, 41, 43, 43, 40, 45, 41, 64,…
$ height &lt;dbl&gt; 166.6, 154.3, 168.1, 178.9, 168.7, 155.1, 169.1, 174.4, 166.8, …
$ weight &lt;dbl&gt; 59.8, 51.4, 61.2, 71.8, 70.5, 32.7, 62.2, 70.2, 68.5, 55.3, 56.…
$ income &lt;dbl&gt; 1094707, 370882, 12449508, 25811696, 1182427, 706000, 825437, 1…</code></pre>
</div>
</div>
</section><section id="spss" class="level4" data-number="4.2.4.2"><h4 data-number="4.2.4.2" class="anchored" data-anchor-id="spss">
<span class="header-section-number">4.2.4.2</span> <strong>SPSS</strong>
</h4>
<p>かつてよく使われた（今でも経済学以外の分野では使われることがある）統計分析ソフトに、SPSSというものがある。 SPSS 形式のデータには、<strong>.sav</strong>という拡張子が付いている。 Rでは、<code><a href="https://haven.tidyverse.org/reference/read_spss.html">haven::read_sav()</a></code> （または <code><a href="https://haven.tidyverse.org/reference/read_spss.html">haven::read_spss()</a></code>）で読み込める。</p>
<p>例として、<a href="https://yukiyanai.github.io/jp/classes/econometrics1/contents/data/fake_data_spss.sav">fake_data_spss.sav</a> をダウンロードし、<strong>data</strong> フォルダに保存しよう。</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"https://yukiyanai.github.io/jp/classes/econometrics1/contents/data/fake_data_spss.sav"</span>,</span>
<span>              destfile <span class="op">=</span> <span class="st">"data/fake_data_spss.sav"</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>このファイルは、以下のコマンドで読み込める。</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mysav</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://haven.tidyverse.org/reference/read_spss.html">read_sav</a></span><span class="op">(</span><span class="st">"data/fake_data_spss.sav"</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>RStudio の Environment タブで、データが読み込めたことを確認しよう。</p>
<p>念のために中身も少しだけ確認しておこう。</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">mysav</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100
Columns: 6
$ id     &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, …
$ sex    &lt;dbl+lbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ age    &lt;dbl&gt; 67, 57, 58, 40, 24, 59, 58, 31, 24, 53, 31, 29, 40, 61, 43, 53,…
$ height &lt;dbl&gt; 167.7, 167.1, 164.9, 171.7, 167.2, 172.9, 160.6, 167.7, 167.9, …
$ weight &lt;dbl&gt; 58.5, 54.5, 62.9, 68.8, 59.8, 83.6, 54.5, 72.9, 57.6, 54.2, 49.…
$ income &lt;dbl&gt; 1659808, 1550051, 3139595, 4563089, 1864069, 5311530, 42952064,…</code></pre>
</div>
</div>
</section><section id="その他" class="level4" data-number="4.2.4.3"><h4 data-number="4.2.4.3" class="anchored" data-anchor-id="その他">
<span class="header-section-number">4.2.4.3</span> <strong>その他</strong>
</h4>
<p>Rはこの他には様々な形式のデータを読むことができる。必要に応じて他の方法も解説するが、この授業で他の形式が必要になることはないはずである。</p>
</section></section></section><section id="データの前処理" class="level2" data-number="4.3"><h2 data-number="4.3" class="anchored" data-anchor-id="データの前処理">
<span class="header-section-number">4.3</span> データの前処理</h2>
<p>当たり前のことだが、データ分析にはデータが必要である。データはどうやって手に入れればいいだろうか。</p>
<p>現代では、インターネットを通じて様々なデータセットを手に入れることができる。例えば、日本の政府が集めたデータ（政府統計）の多くは、<a href="https://https://www.stat.go.jp/">総務省統計局のウェブサイト</a> や <a href="https://www.e-stat.go.jp/">e-Stat</a> から入手できる。あるいは、先進諸国の経済指標は、<a href="https://stats.oecd.org/">OECD.Stat</a> からダウンロードすることができる。</p>
<p>データを入手したらすぐ分析したくなるだろう。しかし、たいていの場合、入手したデータをそのままの状態で分析するのは難しい。インターネットからダウンロードしたデータセットは、データ分析に適した形式でなかったり、分析対象となる変数以外の余計な情報を含んでいたり、変数の中におかしな値（典型的には、入力ミス）をもっていたりする。そのようなデータセットをありのままで分析しようとすると、誤った推論をしたり、分析を実行するためのRコードがそもそも動かないという問題に直面する。</p>
<p>そこで必要になるのが、データの<strong>前処理 (pre-processing)</strong> である。データの収集から分析結果の報告までの一連の過程全体を「データ分析」と呼ぶことにすると、通常、データ分析でもっとも多くの時間を割くのが「前処理」の部分である。たとえば、線形回帰分析を実行することを考えよう。自分が推定した特定の統計モデル（統計モデルについては今後の授業で説明する）とそのために必要なデータフレームさえあれば、回帰分析は <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> ですぐに実行可能である。つまり、統計モデルを推定するのは、1つのコマンドで実行可能である。</p>
<p>しかし、これを可能にするためには、<code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> が期待する形式でデータフレームを用意する必要がある。具体的には、行列形式のデータセットで、各行<span class="math inline">\(i\)</span>が1ひとつの観測個体を表しており、各列<span class="math inline">\(j\)</span>が各変数を表し、各セル (<span class="math inline">\(i, j\)</span>) が個体<span class="math inline">\(i\)</span>の変数<span class="math inline">\(j\)</span>の値を保持している必要がある。これまではすでにこの形式で用意されたデータセットを使って実習してきたが、この形式のデータを作るのは、必ずしも楽ではない。少なくとも、決まったRのコマンドを1つ実行しさえすれば望んだデータフレームができるというような簡単な作業ではない。</p>
<p>データの前処理は、データ分析をする上で避けて通れない道である。今回は、Rでデータの前処理をするための便利な方法を学習しよう。</p>
<section id="tidy-なデータ" class="level3" data-number="4.3.1"><h3 data-number="4.3.1" class="anchored" data-anchor-id="tidy-なデータ">
<span class="header-section-number">4.3.1</span> Tidy なデータ</h3>
<p>まず、最終的にどのようなデータフレームが必要かを理解しよう。ここでは、データ分析の方法として一般的な線形回帰分析（あるいは、一般化線形モデル; GLM）を行うためのデータフレームを考える（他の方法で分析を行う場合は、異なる形式のデータフレームを用意する必要があるかもしれない。たとえば、コンジョイント分析を行う場合には、今回説明するものとは異なるデータフレームが必要である）。</p>
<p>私たちが通常必要とするのは、<strong>tidy data</strong>（整然データ）と呼ばれるものである。整然データについては、<a href="https://www.jaysong.net/RBook/tidydata.html">宋・矢内『私たちのR』第16章</a>を参照されたい。整然データを用意すれば、回帰分析だけでなく、ggplot2 を使った作図にも使える。</p>
<p>Tidy data は、次の4つの条件を満たすデータである。</p>
<ol type="1">
<li>1つの列は、1つの変数を表す。</li>
<li>1つの行は、1つの観測を表す。</li>
<li>1つのセル（特定の列の特定の行）は、1つの値を表す。</li>
<li>1つの表は、1つの観測単位 (unit of observation) をもつ（異なる観測単位が混ざっていない）</li>
</ol>
<p>データを入手したら（あるいは、自分でデータセットを作るときは）、この条件がすべて満たされているか確認しよう。満たされていなければ、tidy data に変換するための前処理が必要になる。</p>
</section><section id="様々な前処理" class="level3" data-number="4.3.2"><h3 data-number="4.3.2" class="anchored" data-anchor-id="様々な前処理">
<span class="header-section-number">4.3.2</span> 様々な前処理</h3>
<p>CSVファイルは用意されていると仮定する。</p>
<p>官庁のウェブサイト等で公開されているデータは、ファイルの冒頭にデータの説明文などの、データセットの中身ではない情報が含まれている場合がある。例えば、最初の3行が余計だとすると、その3行をとばしてデータを読み込みたい。そういう場合は、<code><a href="https://readr.tidyverse.org/reference/read_delim.html">readr::read_csv()</a></code> の <code>skip</code> 引数を指定する。<strong>foo.csv</strong> というデータセットがあるとすると（実際にはないので、以下のコマンドを実行してもエラーになる。以下、「あるとする」と言った場合は同様）、次のようにして読める。</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">MYD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"foo.csv"</span>, skip <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Rでは欠測値（本来ならセルに入っているべき値が、何らかの理由 [アンケートでの回答拒否、政府が情報を公開していない、etc.] で欠けている場合）は、<code>NA</code> で表すことになっている。 自分が用意したCSVファイル（あるいはその元になったMS Excel ファイル）で、 NA と入力されているか完全に空欄になっているセルがある場合、<code><a href="https://readr.tidyverse.org/reference/read_delim.html">readr::read_csv()</a></code> は自動的にRの<code>NA</code> に変換してくれる。しかし、インターネット等でダウンロードしたファイルでは、欠測を他の方法で表記している場合があり、対応が必要である。<code><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv()</a></code> では、<strong>na</strong> 引数を指定すればよい。例えば、欠測が<code>.</code>（ドット）で表されている <strong>foo.csv</strong> があるとすれば、</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">MYD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"foo.csv"</span>, na <span class="op">=</span> <span class="st">'.'</span><span class="op">)</span> </span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>とすればよい。あるいは、欠測が 99 または -9 のいずれかで表現されているなら、</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">MYD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"foo.csv"</span>, na <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">99</span>, <span class="op">-</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>とする。</p>
<p>ここからは、実際のデータを使って実習しよう。 『Rによる計量政治学』（浅野正彦, 矢内勇生. 2018）で使用されているデータ（<a href="https://raw.githubusercontent.com/yukiyanai/quant-methods-R/master/data/hr-data.csv">hr-data.csv</a>）を使う。</p>
<p>まず、データをダウンロードして保存する。</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span></span>
<span>    url <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/yukiyanai/quant-methods-R/master/data/hr-data.csv"</span>,</span>
<span>    destfile <span class="op">=</span> <span class="st">"data/hr-data.csv"</span></span>
<span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>データを読み込む。</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">myd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/hr-data.csv"</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 8803 Columns: 22
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (7): ku, status, name, party, wl, smd, party_jpn
dbl (15): year, kun, party_code, previous, voteshare, age, nocand, rank, vot...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p><code><a href="https://rdrr.io/r/utils/download.file.html">download.file()</a></code> でダウンロードできなかったり、ダウンロードしたファイルが壊れているときは、データのリンクをクリック（または右クリック）して手動でダウンロードして使う（今後も同様）。</p>
<p>既に学習済みのはずだが、特定の条件を満たす部分だけ利用したい場合は、<code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code> を使う。 <code>year</code> の値が1996で、<code>party_jpn</code> が自民党のものだけ取り出してみよう。 取り出す前のデータを確認する。</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">myd</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">party_jpn</span><span class="op">)</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      party_jpn
year   さきがけ その他 みんな 保守党 保守新党 公明党 共産党 国民党 国民新党
  1996       13     20      0      0        0      0    299     10        0
  2000        0      8      0     16        0     18    300      0        0
  2003        0      3      0      0       11     10    300      1        0
  2005        0      1      0      0        0      9    275      0       10
  2009        0      1     14      0        0      6    152      0        9
  2012        0      5     65      0        0      9    299      0        2
  2014        0      5      0      0        0      9    292      0        0
  2017        0     44      0      0        0      9    206      0        0
      party_jpn
year   大地 希望 幸福実現党 新党日本 新社会党 新進党 未来 次世代 民主党 無所属
  1996    0    0          0        0       37    235    0      0    143     85
  2000    0    0          0        0        1      0    0      0    242     79
  2003    0    0          0        0        0      0    0      0    267     92
  2005    1    0          0        6        0      0    0      0    289     70
  2009    0    0        292        2        0      0    0      0    271     70
  2012    7    0         20        1        0      0  111      0    264     48
  2014    0    0          0        0        0      0    0     39    178     45
  2017    0  198          0        0        0      0    0      0      0     73
      party_jpn
year   無所属の会 生活 社民党 立憲民主党 維新の会 維新の党 自民党 自由党
  1996          0    0     43          0        0        0    288      0
  2000          9    0     71          0        0        0    271     61
  2003          0    0     64          0        0        0    277      0
  2005          0    0     38          0        0        0    290      0
  2009          0    0     31          0        0        0    291      0
  2012          0    0     23          0      151        0    289      0
  2014          0   13     18          0        0       77    283      0
  2017          0    0     19         63       47        0    277      0
      party_jpn
year   自由連合
  1996       88
  2000      123
  2003        1
  2005        0
  2009        0
  2012        0
  2014        0
  2017        0</code></pre>
</div>
</div>
<p><code>filter</code> で条件（1996年の自民党候補）を満たすものを取り出す。</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">LDP1996</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">myd</span>, <span class="va">year</span> <span class="op">==</span> <span class="fl">1996</span>, </span>
<span>                  <span class="va">party_jpn</span> <span class="op">==</span> <span class="st">"自民党"</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>確認する。</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">LDP1996</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">party_jpn</span><span class="op">)</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      party_jpn
year   自民党
  1996    288</code></pre>
</div>
</div>
<p>上の操作は、パイプ <code>|&gt;</code> を使うと次のように書ける。</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">LDP1996</span> <span class="op">&lt;-</span> <span class="va">myd</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">1996</span>, </span>
<span>           <span class="va">party_jpn</span> <span class="op">==</span> <span class="st">"自民党"</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>特定の変数だけを残したい場合は、<code><a href="https://dplyr.tidyverse.org/reference/select.html">dplyr::select()</a></code> で変数を指定する。 まず、<code>myd</code> にどんな変数があるのか見てみよう。</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">myd</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "year"       "ku"         "kun"        "status"     "name"      
 [6] "party"      "party_code" "previous"   "wl"         "voteshare" 
[11] "age"        "nocand"     "rank"       "vote"       "eligible"  
[16] "turnout"    "exp"        "expm"       "vs"         "exppv"     
[21] "smd"        "party_jpn" </code></pre>
</div>
</div>
<p>この中で、<code>year</code> と <code>name</code> と <code>vs</code> だけ残してみよう。</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sub1</span> <span class="op">&lt;-</span> <span class="va">myd</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">name</span>, <span class="va">vs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sub1</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "year" "name" "vs"  </code></pre>
</div>
</div>
<p><code>kun</code> から<code>party</code> までの変数をすべて残したいときは、次のように書ける。</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sub2</span> <span class="op">&lt;-</span> <span class="va">myd</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">kun</span><span class="op">:</span><span class="va">party</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sub2</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "kun"    "status" "name"   "party" </code></pre>
</div>
</div>
<p>特定の変数だけ除外したいときは、<code>!</code>を使って指定する。<code>status</code> と <code>vs</code> だけ消してみよう。</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sub3</span> <span class="op">&lt;-</span> <span class="va">myd</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">status</span>, <span class="va">vs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sub3</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "year"       "ku"         "kun"        "name"       "party"     
 [6] "party_code" "previous"   "wl"         "voteshare"  "age"       
[11] "nocand"     "rank"       "vote"       "eligible"   "turnout"   
[16] "exp"        "expm"       "exppv"      "smd"        "party_jpn" </code></pre>
</div>
</div>
<p>特定の文字から始まる変数だけ残したいときは、<code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with()</a></code> が使える。変数名が “e” から始まるものだけ残してみよう（この例には特に意味はないが、変数名が <code>x1</code>, <code>x2</code>, <code>x3</code>, <code>y1</code>, <code>y2</code>, <code>y3</code>,… のようになっていて、<code>x</code>から始まる変数だけ取り出したいときなどに便利である）。</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sub4</span> <span class="op">&lt;-</span> <span class="va">myd</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"e"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sub4</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "eligible" "exp"      "expm"     "exppv"   </code></pre>
</div>
</div>
<p>同じように、特定の文字で終わるものは、<code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with()</a></code> で取り出せる。変数名が “d” で終わるものだけ残してみよう（この例には特に意味はないが、変数名が <code>x2000</code>, <code>x2001</code>, <code>x2002</code>, …, <code>y2000</code>, <code>y2001</code>, <code>y2002</code>,… のようになっていて、“2000”で終わる変数だけ取り出したいときなどに便利である）。</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sub5</span> <span class="op">&lt;-</span> <span class="va">myd</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"d"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sub5</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "nocand" "smd"   </code></pre>
</div>
</div>
<p>変数名に特定の文字列を含むものは、<code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains()</a></code> で取り出せる。変数名に”te” が含まれるものだけ取り出してみよう。</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sub6</span> <span class="op">&lt;-</span> <span class="va">myd</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"te"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sub6</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "voteshare" "vote"     </code></pre>
</div>
</div>
<p><code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>してから<code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> するなど、複数の操作を行いたいときは、パイプでつなぐ。例えば、</p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">LDP1996_sub1</span> <span class="op">&lt;-</span> <span class="va">myd</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">1996</span>, </span>
<span>           <span class="va">party_jpn</span> <span class="op">==</span> <span class="st">"自民党"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">name</span>, <span class="va">vs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">LDP1996_sub1</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "year" "name" "vs"  </code></pre>
</div>
</div>
<p>ということができる。つまり、<code>|&gt;</code> （パイプ）は、“and then” という接続詞である考えることができる。</p>
<p>これをパイプを使わずに実行するには、次のように書く必要がある。</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">LDP1996_sub1_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">myd</span>, <span class="va">year</span> <span class="op">==</span> <span class="fl">1996</span>, <span class="va">party_jpn</span> <span class="op">==</span> <span class="st">"自民党"</span><span class="op">)</span>, <span class="va">year</span>, <span class="va">name</span>, <span class="va">vs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">LDP1996_sub1_2</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "year" "name" "vs"  </code></pre>
</div>
</div>
<p>書くのも読むのも大変である。</p>
<p>新しい変数を作りたいときは、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> を使う。例えば、パーセント（0以上100以下）で測定されている turnout（投票率）という変数を元に、0から1の範囲で投票率を測るturnout2という変数を作りたいなら、次のようにする。</p>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">myd</span> <span class="op">&lt;-</span> <span class="va">myd</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>turnout2 <span class="op">=</span> <span class="va">turnout</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">myd</span><span class="op">$</span><span class="va">turnout</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">myd</span><span class="op">$</span><span class="va">turnout2</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Min. 1st Qu. Median       Mean  3rd Qu.   Max. NA's
[1,] 48.900  57.800 62.700 62.9562247 67.52500 83.800 1895
[2,]  0.489   0.578  0.627  0.6295622  0.67525  0.838 1895</code></pre>
</div>
</div>
<p>複数の変数を同時に作ることもできる。自民党候補であることを表す <code>LDP</code> というダミー変数と、民主党候補の<code>DPJ</code>ダミーを作ろう。</p>
<div class="cell">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">myd</span> <span class="op">&lt;-</span> <span class="va">myd</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>LDP <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">party_jpn</span> <span class="op">==</span> <span class="st">"自民党"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>           DPJ <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">party_jpn</span> <span class="op">==</span> <span class="st">"民主党"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">myd</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">party_jpn</span>, <span class="va">LDP</span><span class="op">)</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            LDP
party_jpn       0    1
  さきがけ     13    0
  その他       87    0
  みんな       79    0
  保守党       16    0
  保守新党     11    0
  公明党       70    0
  共産党     2123    0
  国民党       11    0
  国民新党     21    0
  大地          8    0
  希望        198    0
  幸福実現党  312    0
  新党日本      9    0
  新社会党     38    0
  新進党      235    0
  未来        111    0
  次世代       39    0
  民主党     1654    0
  無所属      562    0
  無所属の会    9    0
  生活         13    0
  社民党      307    0
  立憲民主党   63    0
  維新の会    198    0
  維新の党     77    0
  自民党        0 2266
  自由党       61    0
  自由連合    212    0</code></pre>
</div>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">myd</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">party_jpn</span>, <span class="va">DPJ</span><span class="op">)</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            DPJ
party_jpn       0    1
  さきがけ     13    0
  その他       87    0
  みんな       79    0
  保守党       16    0
  保守新党     11    0
  公明党       70    0
  共産党     2123    0
  国民党       11    0
  国民新党     21    0
  大地          8    0
  希望        198    0
  幸福実現党  312    0
  新党日本      9    0
  新社会党     38    0
  新進党      235    0
  未来        111    0
  次世代       39    0
  民主党        0 1654
  無所属      562    0
  無所属の会    9    0
  生活         13    0
  社民党      307    0
  立憲民主党   63    0
  維新の会    198    0
  維新の党     77    0
  自民党     2266    0
  自由党       61    0
  自由連合    212    0</code></pre>
</div>
</div>
<p>変数名を変えるには、<code><a href="https://dplyr.tidyverse.org/reference/rename.html">dplyr::rename()</a></code> を使う。</p>
<p>例えば、<code>turnout2</code> の名前を <code>tohyoritsu</code> に変更するには、次のようにする。</p>
<div class="cell">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">myd</span> <span class="op">&lt;-</span> <span class="va">myd</span> <span class="op">|&gt;</span>  </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>tohyoritsu <span class="op">=</span> <span class="va">turnout2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">myd</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "year"       "ku"         "kun"        "status"     "name"      
 [6] "party"      "party_code" "previous"   "wl"         "voteshare" 
[11] "age"        "nocand"     "rank"       "vote"       "eligible"  
[16] "turnout"    "exp"        "expm"       "vs"         "exppv"     
[21] "smd"        "party_jpn"  "tohyoritsu" "LDP"        "DPJ"       </code></pre>
</div>
</div>
<p>教科書 5.3.3節 (p.78から) の例を考える。 まず、<a href="https://git.io/fAnmx">横長データ</a> を手に入れる（<code><a href="https://rdrr.io/r/utils/download.file.html">download.file()</a></code> がうまくいかないときは、リンクをクリックして保存）。</p>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"https://git.io/fAnmx"</span>,</span>
<span>              destfile <span class="op">=</span> <span class="st">"data/wide-table.csv"</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>データファイルを読んで中身を確認する。</p>
<div class="cell">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GDP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/wide-table.csv"</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GDP</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  country gdp2000 gdp2005 gdp2010
  &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 A         40000   42000   44000
2 B         38000   40000   43000
3 C         52000   52100   52500</code></pre>
</div>
</div>
<p>これを縦長に変更する。（教科書第1刷では、<code><a href="https://tidyr.tidyverse.org/reference/gather.html">tidyr::gather()</a></code> の使い方が紹介されているが、）ここでは<code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">tidyr::pivot_longer()</a></code> を使おう。</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GDP_long</span> <span class="op">&lt;-</span> <span class="va">GDP</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">!</span><span class="va">country</span>,      <span class="co"># 縦長にする範囲：country 以外</span></span>
<span>                 names_to <span class="op">=</span> <span class="st">"year"</span>,    <span class="co"># 元の列がどれだっかを区別する変数：年</span></span>
<span>                 names_prefix <span class="op">=</span> <span class="st">"gdp"</span>, <span class="co"># 元の変数名のうち、区別に不要な部分</span></span>
<span>                 values_to <span class="op">=</span> <span class="st">"gdp"</span><span class="op">)</span>    <span class="co"># 元の値を保持する変数名</span></span>
<span><span class="va">GDP_long</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  country year    gdp
  &lt;chr&gt;   &lt;chr&gt; &lt;dbl&gt;
1 A       2000  40000
2 A       2005  42000
3 A       2010  44000
4 B       2000  38000
5 B       2005  40000
6 B       2010  43000
7 C       2000  52000
8 C       2005  52100
9 C       2010  52500</code></pre>
</div>
</div>
<p>このように、望んだ形式のデータに一発で変換できる。</p>
<p>これを横長に戻してみよう。（教科書1刷で紹介されている<code><a href="https://tidyr.tidyverse.org/reference/spread.html">tidyr::spread()</a></code> の代わりに、）<code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">tidyr::pivot_wider()</a></code> を使おう。</p>
<div class="cell">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GDP_wide</span> <span class="op">&lt;-</span> <span class="va">GDP_long</span> <span class="op">|&gt;</span>  </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">year</span>,    <span class="co"># 横長にした後の列を区別する変数</span></span>
<span>                names_prefix <span class="op">=</span> <span class="st">"gdp"</span>, <span class="co"># 横長にした後の変数名の冒頭につける文字列（オプション）</span></span>
<span>                values_from <span class="op">=</span> <span class="va">gdp</span><span class="op">)</span>    <span class="co"># 縦長から横長に分配する値</span></span>
<span><span class="va">GDP_wide</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  country gdp2000 gdp2005 gdp2010
  &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 A         40000   42000   44000
2 B         38000   40000   43000
3 C         52000   52100   52500</code></pre>
</div>
</div>
<p>このように、元の横長データに戻すことができる。</p>
<p><code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code> と<code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code> を比較して、対応関係を理解しよう。</p>
<p>自分でデータフレームを作りたいときは、<code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble::tibble()</a></code> を使う。</p>
<div class="cell">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">newd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>,</span>
<span>               x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, mean <span class="op">=</span> <span class="fl">10</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">1.2</span> <span class="op">+</span> <span class="fl">0.8</span> <span class="op">*</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">newd</span><span class="op">)</span></span></code><button title="コピーする" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100
Columns: 3
$ id &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, …
$ x  &lt;dbl&gt; 8.635471, 11.503324, 9.915456, 9.247058, 9.967508, 9.863759, 9.7144…
$ y  &lt;dbl&gt; 8.725004, 11.138400, 7.727973, 7.519724, 8.107329, 8.959142, 7.3124…</code></pre>
</div>
</div>
<p>複数のデータセットを結合する方法については、教科書第5章と<a href="https://www.jaysong.net/RBook/datahandling2.html">宋・矢内『私たちのR』第14章</a>を参照されたい。</p>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/yukiyanai\.github\.io\/metrics\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./regression-intro.html" class="pagination-link  aria-label=">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">回帰分析の基礎</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./regression-estimation.html" class="pagination-link" aria-label="<span class='chapter-number'>5</span>&nbsp; <span class='chapter-title'>回帰分析による統計的推定</span>">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">回帰分析による統計的推定</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2024, Yuki Yanai</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>